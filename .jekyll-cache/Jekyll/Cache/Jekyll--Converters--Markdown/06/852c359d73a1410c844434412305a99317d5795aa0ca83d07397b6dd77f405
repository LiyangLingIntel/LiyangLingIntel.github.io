I"µ'<p>åœ¨åšSpark Dataframeæ“ä½œçš„æ—¶å€™ä¼šé‡åˆ°å¾ˆå¤šéœ€æ±‚. æœ€è¿‘æˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜, å°±æ˜¯é€šè¿‡<code class="highlighter-rouge">agg</code>æ–¹æ³•ä¼ å…¥å¤šç§èšåˆå‡½æ•°å¯¹å¤šåˆ—è¿›è¡Œæ“ä½œ, ç„¶ååå°±ç”Ÿæˆäº†å¤šåˆ—çš„èšåˆç»“æœ. ä½†æ˜¯åˆ—åå°±æ˜¯ä»¥ åŸåˆ—å+èšåˆå‡½æ•°çš„æ–¹æ³•, ç„¶åå°±äº§ç”Ÿéœ€æ±‚ â€”- å¦‚ä½•ä¿®æ”¹è¿™äº›åˆ—åå‘¢?</p>

<p>ç„¶åæ‰¾åˆ°äº†ä»¥ä¸‹æ–¹æ³•:</p>

<ul>
  <li>
    <p>ä½¿ç”¨<code class="highlighter-rouge">selectExpr</code></p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="s">"Alberto"</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s">"Dakota"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> 
                                  <span class="p">[</span><span class="s">"Name"</span><span class="p">,</span> <span class="s">"askdaosdka"</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="c1"># Output
#+-------+----------+
#|   Name|askdaosdka|
#+-------+----------+
#|Alberto|         2|
#| Dakota|         2|
#+-------+----------+
#root
# |-- Name: string (nullable = true)
# |-- askdaosdka: long (nullable = true)
</span>  
<span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s">"Name as name"</span><span class="p">,</span> <span class="s">"askdaosdka as age"</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="c1"># Output
#+-------+---+
#|   name|age|
#+-------+---+
#|Alberto|  2|
#| Dakota|  2|
#+-------+---+
#root
# |-- name: string (nullable = true)
# |-- age: long (nullable = true)
</span></pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>ä½¿ç”¨<code class="highlighter-rouge">withColumnRenamed</code></p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">oldColumns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">names</span>
<span class="n">newColumns</span> <span class="o">=</span> <span class="p">[</span><span class="s">"name"</span><span class="p">,</span> <span class="s">"age"</span><span class="p">]</span>
  
<span class="c1"># è¿™é‡Œçš„reduceæ˜¯pythonçš„reduce
</span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>
<span class="n">df</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">data</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="n">oldColumns</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">newColumns</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oldColumns</span><span class="p">)),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>ä¸ºäº†ä¾¿äºç†è§£è¿™é‡Œç»™å‡ºpython <code class="highlighter-rouge">reduce</code>æ–¹æ³•çš„å®˜æ–¹è§£é‡Š.</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">functools</span><span class="o">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">iterable</span><span class="p">[,</span> <span class="n">initializer</span><span class="p">])</span>
<span class="s">'''
Apply function of two arguments cumulatively to the items of sequence, from left to right, so as to reduce the sequence to a single value. 
'''</span>
  
<span class="c1"># Roughly equivalent to:
</span><span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">initializer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">initializer</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>ç®€å•æ€»ç»“ä¸€ä¸‹, ä¹‹å‰çœ‹åˆ°è¿™ç§å®ç°æ–¹å¼, ä»¥ä¸ºæ˜¯<code class="highlighter-rouge">withColumnRenamed</code>æœ‰ä»€ä¹ˆç‰¹åˆ«é«˜çº§çš„å®ç°, ç°åœ¨ç»“åˆä¸¤éƒ¨åˆ†ä»£ä¹°åˆ†æä¸€ä¸‹, ç®€å•æ¥è¯´è¿˜æ˜¯å°±æ˜¯é€šè¿‡å¾ªç¯, åå¤è°ƒç”¨<code class="highlighter-rouge">withColumnRenamed</code>æ–¹æ³•ç»™dfçš„columné‡å‘½åâ€¦â€¦</p>
  </li>
  <li>
    <p>ä½¿ç”¨<code class="highlighter-rouge">alias</code></p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
  
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">"Name"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">"name"</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s">"askdaosdka"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">"age"</span><span class="p">))</span>
<span class="n">data</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
  
<span class="c1"># Output
#+-------+---+
#|   name|age|
#+-------+---+
#|Alberto|  2|
#| Dakota|  2|
#+-------+---+
</span></pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>ä½¿ç”¨<code class="highlighter-rouge">sqlContext.sql</code></p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">sqlContext</span><span class="o">.</span><span class="n">registerDataFrameAsTable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">"myTable"</span><span class="p">)</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s">"SELECT Name AS name, askdaosdka as age from myTable"</span><span class="p">)</span>
  
<span class="n">df2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
  
<span class="c1"># Output
#+-------+---+
#|   name|age|
#+-------+---+
#|Alberto|  2|
#| Dakota|  2|
#+-------+---+
</span></pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<p>æ€»çš„æ¥è¯´, Pysparkå¹¶æ²¡æœ‰èƒ½æœ‰ä¸€æ¬¡æ€§å¯¹æ•´ä¸ªcolumn namesè¿›è¡Œæ›¿æ¢çš„æ–¹æ³•, åªèƒ½é€šè¿‡ä¸€äº›trické€ä¸ªåˆ—è¿›è¡Œæ“ä½œ. ä»ä¸ªäººå–œå¥½æ¥è¯´, ç¬¬ä¸€ç§å’Œç¬¬äºŒç§å®ç°æ–¹å¼æ„Ÿè§‰ä¼šç›¸å¯¹ç®€å•.</p>

<p>ä¸»è¦æ–¹æ³•è½¬è½½è‡ªï¼š<a href="https://codeday.me/bug/20180407/150940.html">python â€“ å¦‚ä½•æ›´æ”¹pysparkä¸­çš„æ•°æ®æ¡†åˆ—åï¼Ÿ</a> - <a href="https://codeday.me/">ä»£ç æ—¥å¿—</a></p>
:ET